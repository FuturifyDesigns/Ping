<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Reset Password - Ping</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    button:focus,input:focus,a:focus{outline:none}
    body{font-family:'DM Sans',-apple-system,BlinkMacSystemFont,sans-serif;background:#0A1929;color:#fff;min-height:100vh;min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:16px}
    body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:radial-gradient(circle at 20% 80%,rgba(33,150,243,.08)0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(25,118,210,.06)0%,transparent 50%);z-index:0}
    .container{position:relative;z-index:1;width:100%;max-width:420px}
    .card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:36px 28px;backdrop-filter:blur(20px)}
    @media(max-width:480px){.card{padding:28px 20px;border-radius:16px}}
    .logo{text-align:center;margin-bottom:28px}
    .logo-icon{width:56px;height:56px;background:rgba(33,150,243,.15);border-radius:14px;display:inline-flex;align-items:center;justify-content:center;margin-bottom:12px}
    .logo-icon svg{width:28px;height:28px;fill:#2196F3}
    .logo h1{font-size:22px;font-weight:700;letter-spacing:-.5px}
    .logo p{color:rgba(255,255,255,.5);font-size:13px;margin-top:2px}
    .title{font-size:20px;font-weight:600;margin-bottom:6px;text-align:center}
    .subtitle{color:rgba(255,255,255,.5);font-size:13px;text-align:center;margin-bottom:24px;line-height:1.5}
    .loading-view{text-align:center;padding:40px 0}
    .loading-spinner{width:40px;height:40px;border:3px solid rgba(255,255,255,.1);border-top-color:#2196F3;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px}
    .loading-view p{color:rgba(255,255,255,.5);font-size:14px}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;font-size:13px;font-weight:500;color:rgba(255,255,255,.7);margin-bottom:6px}
    .input-wrapper{position:relative}
    .input-wrapper>svg.fi{position:absolute;left:14px;top:50%;transform:translateY(-50%);width:18px;height:18px;fill:rgba(255,255,255,.3);pointer-events:none;transition:fill .2s;z-index:1}
    .input-wrapper:focus-within>svg.fi{fill:#2196F3}
    input[type="password"],input[type="text"]{width:100%;padding:14px 48px 14px 44px;background:rgba(255,255,255,.07);border:1.5px solid rgba(255,255,255,.12);border-radius:12px;color:#fff;font-family:inherit;font-size:15px;outline:none;transition:border-color .2s,background .2s;-webkit-appearance:none}
    input:focus{border-color:#2196F3;background:rgba(33,150,243,.05)}
    input::placeholder{color:rgba(255,255,255,.25)}
    input.input-error{border-color:#EF4444}
    .toggle-pw{position:absolute;right:4px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:10px;display:flex;align-items:center;justify-content:center;user-select:none;z-index:2}
    .toggle-pw svg{width:20px;height:20px;fill:rgba(255,255,255,.35);transition:fill .15s;pointer-events:none}
    .toggle-pw:hover svg,.toggle-pw:active svg{fill:rgba(255,255,255,.7)}
    .strength-bar{height:4px;border-radius:4px;background:rgba(255,255,255,.08);margin-top:10px;overflow:hidden}
    .strength-fill{height:100%;border-radius:4px;width:0%;transition:width .3s,background .3s}
    .strength-text{font-size:11px;margin-top:5px;color:rgba(255,255,255,.4);text-align:right;min-height:15px}
    .requirements{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .req-tag{font-size:11px;padding:3px 8px;border-radius:6px;background:rgba(255,255,255,.06);color:rgba(255,255,255,.35);transition:all .2s}
    .req-tag.met{background:rgba(16,185,129,.12);color:#10B981}
    .match-hint{font-size:11px;margin-top:6px;min-height:16px;color:rgba(255,255,255,.35);transition:color .2s}
    .match-hint.matched{color:#10B981}.match-hint.mismatch{color:#EF4444}
    .btn{width:100%;padding:15px;background:#2196F3;color:#fff;border:none;border-radius:12px;font-family:inherit;font-size:16px;font-weight:600;cursor:pointer;transition:background .2s,transform .1s;margin-top:20px;user-select:none;touch-action:manipulation}
    .btn:hover{background:#1976D2}.btn:active{transform:scale(.98);background:#1565C0}.btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .btn .spinner{display:none;width:20px;height:20px;border:2.5px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;margin:0 auto}
    .btn.loading .btn-text{display:none}.btn.loading .spinner{display:block}
    @keyframes spin{to{transform:rotate(360deg)}}
    .message{padding:12px 14px;border-radius:10px;font-size:13px;margin-bottom:16px;display:none;line-height:1.5}
    .message.error{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.2);color:#FCA5A5;display:block}
    .success-view{text-align:center;display:none}
    .success-icon{width:72px;height:72px;background:rgba(16,185,129,.12);border:2px solid rgba(16,185,129,.3);border-radius:50%;display:inline-flex;align-items:center;justify-content:center;margin-bottom:18px}
    .success-icon svg{width:36px;height:36px}
    .success-view h2{font-size:22px;font-weight:600;margin-bottom:10px}
    .success-view p{color:rgba(255,255,255,.5);font-size:14px;line-height:1.6;margin-bottom:4px}
    .success-view .close-hint{color:rgba(255,255,255,.35);font-size:13px;margin-top:4px}
    .error-view{text-align:center;display:none}
    .error-icon{width:72px;height:72px;background:rgba(239,68,68,.12);border:2px solid rgba(239,68,68,.3);border-radius:50%;display:inline-flex;align-items:center;justify-content:center;margin-bottom:18px}
    .error-icon svg{width:36px;height:36px;fill:#EF4444}
    .error-view h2{font-size:22px;font-weight:600;margin-bottom:10px}
    .error-view p{color:rgba(255,255,255,.5);font-size:14px;line-height:1.6}
    .back-link{display:inline-block;margin-top:18px;color:#2196F3;text-decoration:none;font-size:14px;font-weight:500}
    .footer{text-align:center;margin-top:20px}
    .footer-brand{display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:4px}
    .footer-brand svg{width:16px;height:16px;opacity:.4}
    .footer-brand span{font-size:13px;font-weight:600;color:rgba(255,255,255,.4)}
    .footer-tagline{font-size:11px;color:rgba(255,255,255,.25)}
  </style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="logo">
      <div class="logo-icon"><svg viewBox="0 0 24 24"><path d="M4 16c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4S4 2.5 4 6v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/></svg></div>
      <h1>Ping</h1>
      <p>Find Your Stop, Faster</p>
    </div>

    <div class="loading-view" id="loadingView">
      <div class="loading-spinner"></div>
      <p>Verifying your reset link...</p>
    </div>

    <div class="error-view" id="errorView" style="display:none">
      <div class="error-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg></div>
      <h2>Invalid Reset Link</h2>
      <p id="errorMsg">This password reset link is invalid or has expired. Please request a new one from the Ping app.</p>
      <a href="/" class="back-link">Back to Ping</a>
    </div>

    <div id="formView" style="display:none">
      <h2 class="title">Set New Password</h2>
      <p class="subtitle">Choose a strong password for your Ping account.</p>
      <div id="messageBox" class="message"></div>
      <form id="resetForm" novalidate>
        <div class="form-group">
          <label for="password">New Password</label>
          <div class="input-wrapper">
            <svg class="fi" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
            <input type="password" id="password" placeholder="At least 8 characters" autocomplete="new-password" required>
            <button type="button" class="toggle-pw" aria-label="Show password"><svg class="eo" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg><svg class="ec" viewBox="0 0 24 24" style="display:none"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg></button>
          </div>
          <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
          <div class="strength-text" id="strengthText"></div>
          <div class="requirements"><span class="req-tag" id="reqLen">8+ chars</span><span class="req-tag" id="reqUpper">uppercase</span><span class="req-tag" id="reqNum">number</span></div>
        </div>
        <div class="form-group">
          <label for="confirmPassword">Confirm Password</label>
          <div class="input-wrapper">
            <svg class="fi" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
            <input type="password" id="confirmPassword" placeholder="Re-enter your password" autocomplete="new-password" required>
            <button type="button" class="toggle-pw" aria-label="Show password"><svg class="eo" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg><svg class="ec" viewBox="0 0 24 24" style="display:none"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg></button>
          </div>
          <div class="match-hint" id="matchHint"></div>
        </div>
        <button type="submit" class="btn" id="submitBtn"><span class="btn-text">Reset Password</span><div class="spinner"></div></button>
      </form>
    </div>

    <div class="success-view" id="successView">
      <div class="success-icon"><svg fill="none" stroke="#10B981" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
      <h2>Password Updated!</h2>
      <p>Your password has been successfully changed. You can now sign in with your new password in the Ping app.</p>
      <p class="close-hint">You can close this page now.</p>
    </div>
  </div>

  <div class="footer">
    <div class="footer-brand"><svg viewBox="0 0 24 24" fill="rgba(255,255,255,.4)"><path d="M4 16c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4S4 2.5 4 6v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/></svg><span>Ping</span></div>
    <div class="footer-tagline">Find Your Stop, Faster</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const SUPABASE_URL='https://nxpaeiwodpyujuksbewx.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54cGFlaXdvZHB5dWp1a3NiZXd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDIxMTAsImV4cCI6MjA4MzM3ODExMH0.oKdliaPQimib8Uknt12bUumw1WvUgvXp0hviDavx2xc';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const loadingView=document.getElementById('loadingView');
const formView=document.getElementById('formView');
const successView=document.getElementById('successView');
const errorView=document.getElementById('errorView');
const errorMsg=document.getElementById('errorMsg');
const messageBox=document.getElementById('messageBox');
const resetForm=document.getElementById('resetForm');
const submitBtn=document.getElementById('submitBtn');
const passwordInput=document.getElementById('password');
const confirmInput=document.getElementById('confirmPassword');

let ready=false;

function showForm(){ready=true;loadingView.style.display='none';formView.style.display='block';errorView.style.display='none'}
function showError(m){if(ready)return;loadingView.style.display='none';formView.style.display='none';errorView.style.display='block';if(m)errorMsg.textContent=m}

async function init(){
  const params=new URLSearchParams(window.location.search);
  const hash=window.location.hash;

  // ─── Method 1: token_hash in query params (from custom email template) ───
  const tokenHash=params.get('token_hash');
  const type=params.get('type');
  if(tokenHash && type){
    console.log('[Reset] Found token_hash in query params, verifying OTP...');
    try{
      const{data,error}=await supabase.auth.verifyOtp({token_hash:tokenHash,type:type});
      if(error)throw error;
      if(data?.session){showForm();return}
      throw new Error('No session returned');
    }catch(e){
      console.log('[Reset] verifyOtp failed:',e.message);
      if(e.message?.includes('expired')){showError('This reset link has expired. Please request a new one from the Ping app.')}
      else{showError('This reset link is invalid or has expired. Please request a new one from the Ping app.')}
      return;
    }
  }

  // ─── Method 2: access_token in hash (from ConfirmationURL redirect) ───
  if(hash.includes('access_token')){
    console.log('[Reset] Found access_token in hash, letting Supabase process...');
    supabase.auth.onAuthStateChange((event,session)=>{
      if(event==='PASSWORD_RECOVERY'||event==='SIGNED_IN'){showForm()}
    });
    // Also try getSession after a moment
    setTimeout(async()=>{
      if(!ready){
        const{data}=await supabase.auth.getSession();
        if(data?.session){showForm()}
        else{showError('Could not verify the reset link. Try opening it in Chrome or Safari instead of your email app.')}
      }
    },6000);
    return;
  }

  // ─── Method 3: error in URL ───
  if(params.has('error')||hash.includes('error=')){
    const desc=params.get('error_description')||'';
    if(desc.toLowerCase().includes('expired')){showError('This reset link has expired. Please request a new one from the Ping app.')}
    else{showError(desc.replace(/\+/g,' ')||'This reset link is invalid.')}
    return;
  }

  // ─── Method 4: Check existing session (maybe already logged in) ───
  const{data}=await supabase.auth.getSession();
  if(data?.session){showForm();return}

  // ─── Nothing found ───
  showError('This password reset link is invalid or has expired. Please request a new one from the Ping app.');
}
init();

// Toggle password
document.querySelectorAll('.toggle-pw').forEach(btn=>{
  btn.addEventListener('click',function(e){
    e.preventDefault();
    const w=this.closest('.input-wrapper'),inp=w.querySelector('input');
    const h=inp.type==='password';
    inp.type=h?'text':'password';
    this.querySelector('.eo').style.display=h?'none':'block';
    this.querySelector('.ec').style.display=h?'block':'none';
    inp.focus();
  });
});

// Password strength
passwordInput.addEventListener('input',updateStrength);
confirmInput.addEventListener('input',updateMatch);
function updateStrength(){
  const pw=passwordInput.value,fill=document.getElementById('strengthFill'),text=document.getElementById('strengthText');
  let s=0;const hL=pw.length>=8,hU=/[A-Z]/.test(pw),hN=/[0-9]/.test(pw),hLo=/[a-z]/.test(pw),hS=/[^A-Za-z0-9]/.test(pw);
  if(hL)s++;if(hU)s++;if(hN)s++;if(hLo)s++;if(hS)s++;if(pw.length>=12)s++;
  document.getElementById('reqLen').classList.toggle('met',hL);
  document.getElementById('reqUpper').classList.toggle('met',hU);
  document.getElementById('reqNum').classList.toggle('met',hN);
  const l=[{w:'0%',c:'transparent',t:''},{w:'17%',c:'#EF4444',t:'Weak'},{w:'33%',c:'#EF4444',t:'Weak'},{w:'50%',c:'#F59E0B',t:'Fair'},{w:'75%',c:'#10B981',t:'Strong'},{w:'90%',c:'#10B981',t:'Very strong'},{w:'100%',c:'#10B981',t:'Excellent'}];
  const v=pw.length===0?l[0]:l[Math.min(s,6)];
  fill.style.width=v.w;fill.style.background=v.c;text.textContent=v.t;text.style.color=v.c;
  if(confirmInput.value.length>0)updateMatch();
}
function updateMatch(){
  const h=document.getElementById('matchHint'),pw=passwordInput.value,c=confirmInput.value;
  if(!c.length){h.textContent='';h.className='match-hint';confirmInput.classList.remove('input-error');return}
  if(pw===c){h.textContent='✓ Passwords match';h.className='match-hint matched';confirmInput.classList.remove('input-error')}
  else{h.textContent='✗ Passwords do not match';h.className='match-hint mismatch';confirmInput.classList.add('input-error')}
}

// Submit
resetForm.addEventListener('submit',async(e)=>{
  e.preventDefault();
  const pw=passwordInput.value,cf=confirmInput.value;
  if(pw.length<8){showMsg('Password must be at least 8 characters.','error');passwordInput.focus();return}
  if(!/[A-Z]/.test(pw)){showMsg('Password must contain at least one uppercase letter.','error');passwordInput.focus();return}
  if(!/[0-9]/.test(pw)){showMsg('Password must contain at least one number.','error');passwordInput.focus();return}
  if(pw!==cf){showMsg('Passwords do not match.','error');confirmInput.focus();return}
  submitBtn.classList.add('loading');submitBtn.disabled=true;messageBox.className='message';messageBox.style.display='none';
  try{
    const{error}=await supabase.auth.updateUser({password:pw});
    if(error){
      const m=(error.message||'').toLowerCase();
      if(m.includes('same')||m.includes('different')||m.includes('already been used')||m.includes('previous')||m.includes('reuse'))
        throw new Error('New password cannot be the same as your current password. Please choose a different one.');
      throw error;
    }
    formView.style.display='none';successView.style.display='block';
  }catch(err){
    showMsg(err.message||'Failed to reset password. Please try again.','error');
    submitBtn.classList.remove('loading');submitBtn.disabled=false;
  }
});
function showMsg(t,ty){messageBox.textContent=t;messageBox.className='message '+ty;messageBox.style.display='block'}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password - Ping</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a2332;
      color: #fff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .card {
      background: #243447;
      border-radius: 16px;
      padding: 48px 40px;
      width: 100%;
      max-width: 460px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    @media (max-width: 500px) {
      .card { padding: 36px 24px; }
    }

    .icon-circle {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
    }

    .icon-circle.lock {
      background: rgba(33, 150, 243, 0.15);
      border: 3px solid rgba(33, 150, 243, 0.4);
    }

    .icon-circle.success {
      background: rgba(45, 212, 191, 0.15);
      border: 3px solid rgba(45, 212, 191, 0.4);
    }

    .icon-circle.error-ic {
      background: rgba(239, 68, 68, 0.15);
      border: 3px solid rgba(239, 68, 68, 0.4);
    }

    .icon-circle svg { width: 48px; height: 48px; }

    h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 12px;
      letter-spacing: -0.5px;
    }

    .subtitle {
      color: rgba(255, 255, 255, 0.55);
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 32px;
    }

    .form-group { margin-bottom: 20px; text-align: left; }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 8px;
    }

    .input-wrapper { position: relative; }

    input[type="password"], input[type="text"] {
      width: 100%;
      padding: 14px 48px 14px 16px;
      background: rgba(255, 255, 255, 0.06);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: #fff;
      font-family: inherit;
      font-size: 15px;
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus { border-color: #2196F3; }
    input::placeholder { color: rgba(255, 255, 255, 0.2); }

    .eye-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
    }

    .eye-btn svg { width: 20px; height: 20px; fill: rgba(255, 255, 255, 0.3); transition: fill 0.2s; }
    .eye-btn:hover svg { fill: rgba(255, 255, 255, 0.6); }

    .strength-bar {
      height: 4px;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.06);
      overflow: hidden;
      margin-top: 10px;
    }

    .strength-fill {
      height: 100%;
      border-radius: 4px;
      width: 0%;
      transition: width 0.3s, background 0.3s;
    }

    .strength-label {
      font-size: 11px;
      margin-top: 6px;
      text-align: right;
      min-height: 16px;
    }

    .reqs { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }

    .req {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.3);
      transition: all 0.2s;
    }

    .req.met { background: rgba(45, 212, 191, 0.12); color: #2DD4BF; }

    .match-ind { font-size: 12px; margin-top: 8px; min-height: 18px; text-align: left; }
    .match-ind.ok { color: #2DD4BF; }
    .match-ind.no { color: #F87171; }

    .btn {
      width: 100%;
      padding: 15px;
      background: #2196F3;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-family: inherit;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, opacity 0.2s;
      margin-top: 8px;
    }

    .btn:hover { background: #1976D2; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .btn .spinner {
      display: none;
      width: 20px; height: 20px;
      border: 2.5px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin: 0 auto;
    }

    .btn.loading .btn-text { display: none; }
    .btn.loading .spinner { display: block; }

    @keyframes spin { to { transform: rotate(360deg); } }

    .alert {
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 13px;
      margin-bottom: 20px;
      display: none;
      text-align: left;
      line-height: 1.5;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: #FCA5A5;
    }

    .alert.show { display: block; }

    .divider { height: 1px; background: rgba(255, 255, 255, 0.08); margin: 32px 0 24px; }

    .footer-brand { display: flex; align-items: center; justify-content: center; gap: 8px; }
    .footer-brand svg { width: 24px; height: 24px; fill: #2196F3; }
    .footer-brand .name { font-size: 20px; font-weight: 700; color: #2196F3; }
    .footer-tagline { color: rgba(255, 255, 255, 0.35); font-size: 13px; margin-top: 4px; }

    .view { display: none; }
    .view.active { display: block; }
  </style>
</head>
<body>

<div class="card">

  <!-- ERROR VIEW -->
  <div class="view" id="errorView">
    <div class="icon-circle error-ic">
      <svg viewBox="0 0 24 24" fill="#EF4444"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
    </div>
    <h1>Invalid Reset Link</h1>
    <p class="subtitle">This password reset link is invalid or has expired.<br>Please request a new one from the Ping app.</p>
    <div class="divider"></div>
    <div class="footer-brand">
      <svg viewBox="0 0 24 24" fill="#2196F3"><path d="M4 16c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/></svg>
      <span class="name">Ping</span>
    </div>
    <p class="footer-tagline">Find Your Stop, Faster</p>
  </div>

  <!-- FORM VIEW -->
  <div class="view" id="formView">
    <div class="icon-circle lock">
      <svg viewBox="0 0 24 24" fill="#2196F3"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
    </div>
    <h1>Reset Password</h1>
    <p class="subtitle">Choose a new password for your Ping account.</p>

    <div class="alert" id="alertBox"></div>

    <form id="resetForm" autocomplete="off">
      <div class="form-group">
        <label>New Password</label>
        <div class="input-wrapper">
          <input type="password" id="pw" placeholder="Enter new password" autocomplete="new-password" required>
          <button type="button" class="eye-btn" onclick="togglePw('pw')">
            <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
          </button>
        </div>
        <div class="strength-bar"><div class="strength-fill" id="sFill"></div></div>
        <div class="strength-label" id="sLabel"></div>
        <div class="reqs">
          <span class="req" id="r8">8+ characters</span>
          <span class="req" id="rU">1 uppercase</span>
          <span class="req" id="rN">1 number</span>
        </div>
      </div>

      <div class="form-group">
        <label>Confirm Password</label>
        <div class="input-wrapper">
          <input type="password" id="cpw" placeholder="Re-enter new password" autocomplete="new-password" required>
          <button type="button" class="eye-btn" onclick="togglePw('cpw')">
            <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
          </button>
        </div>
        <div class="match-ind" id="matchInd"></div>
      </div>

      <button type="submit" class="btn" id="subBtn" disabled>
        <span class="btn-text">Reset Password</span>
        <div class="spinner"></div>
      </button>
    </form>

    <div class="divider"></div>
    <div class="footer-brand">
      <svg viewBox="0 0 24 24" fill="#2196F3"><path d="M4 16c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/></svg>
      <span class="name">Ping</span>
    </div>
    <p class="footer-tagline">Find Your Stop, Faster</p>
  </div>

  <!-- SUCCESS VIEW -->
  <div class="view" id="successView">
    <div class="icon-circle success">
      <svg viewBox="0 0 24 24" fill="#2DD4BF"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
    </div>
    <h1>Password Updated!</h1>
    <p class="subtitle">Your password has been successfully changed.<br>You can now close this page and sign in to the Ping app with your new password.</p>
    <div class="divider"></div>
    <div class="footer-brand">
      <svg viewBox="0 0 24 24" fill="#2196F3"><path d="M4 16c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/></svg>
      <span class="name">Ping</span>
    </div>
    <p class="footer-tagline">Find Your Stop, Faster</p>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const SUPA_URL = 'https://nxpaeiwodpyujuksbewx.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54cGFlaXdvZHB5dWp1a3NiZXd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MDIxMTAsImV4cCI6MjA4MzM3ODExMH0.oKdliaPQimib8Uknt12bUumw1WvUgvXp0hviDavx2xc';
const sb = window.supabase.createClient(SUPA_URL, SUPA_KEY);

let userEmail = null;
let ready = false;

// ===== INIT =====
async function init() {
  sb.auth.onAuthStateChange((event, session) => {
    if ((event === 'PASSWORD_RECOVERY' || event === 'SIGNED_IN') && session && !ready) {
      ready = true;
      userEmail = session.user?.email || null;
      show('formView');
    }
  });

  const { data } = await sb.auth.getSession();
  if (data?.session) {
    ready = true;
    userEmail = data.session.user?.email || null;
    show('formView');
    return;
  }

  setTimeout(() => { if (!ready) show('errorView'); }, 3000);
}

function show(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

init();

// ===== VALIDATION (matches Flutter app: 8+ chars, 1 uppercase, 1 number) =====
const pw = document.getElementById('pw');
const cpw = document.getElementById('cpw');
const subBtn = document.getElementById('subBtn');

function validate() {
  const p = pw.value;
  const c = cpw.value;
  const h8 = p.length >= 8;
  const hU = /[A-Z]/.test(p);
  const hN = /[0-9]/.test(p);

  document.getElementById('r8').classList.toggle('met', h8);
  document.getElementById('rU').classList.toggle('met', hU);
  document.getElementById('rN').classList.toggle('met', hN);

  // Strength
  let s = 0;
  if (h8) s++; if (hU) s++; if (hN) s++;
  if (/[a-z]/.test(p)) s++;
  if (/[^A-Za-z0-9]/.test(p)) s++;
  if (p.length >= 12) s++;

  const lvls = [
    { w: '0%', c: 'transparent', l: '' },
    { w: '20%', c: '#EF4444', l: 'Weak' },
    { w: '35%', c: '#F59E0B', l: 'Fair' },
    { w: '55%', c: '#F59E0B', l: 'Good' },
    { w: '75%', c: '#2DD4BF', l: 'Strong' },
    { w: '90%', c: '#2DD4BF', l: 'Very strong' },
    { w: '100%', c: '#10B981', l: 'Excellent' },
  ];
  const lv = p.length === 0 ? lvls[0] : lvls[Math.min(s, 6)];
  document.getElementById('sFill').style.cssText = `width:${lv.w};background:${lv.c}`;
  const sl = document.getElementById('sLabel');
  sl.textContent = lv.l;
  sl.style.color = lv.c;

  // Match
  const mi = document.getElementById('matchInd');
  if (c.length > 0) {
    mi.textContent = p === c ? 'Passwords match' : 'Passwords do not match';
    mi.className = 'match-ind ' + (p === c ? 'ok' : 'no');
  } else {
    mi.textContent = '';
    mi.className = 'match-ind';
  }

  subBtn.disabled = !(h8 && hU && hN && p === c && c.length > 0);
}

pw.addEventListener('input', validate);
cpw.addEventListener('input', validate);

function togglePw(id) {
  const el = document.getElementById(id);
  el.type = el.type === 'password' ? 'text' : 'password';
}

// ===== SUBMIT =====
document.getElementById('resetForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (subBtn.disabled) return;

  const newPw = pw.value;
  const alertBox = document.getElementById('alertBox');

  subBtn.classList.add('loading');
  subBtn.disabled = true;
  alertBox.className = 'alert';

  try {
    // Block reuse of old password by trying sign-in with new password first
    if (userEmail) {
      try {
        const { data: sid } = await sb.auth.signInWithPassword({
          email: userEmail,
          password: newPw,
        });
        if (sid?.session) {
          // Sign-in worked = same as old password
          alertBox.textContent = 'Your new password cannot be the same as your current password. Please choose a different one.';
          alertBox.className = 'alert show';
          subBtn.classList.remove('loading');
          subBtn.disabled = false;
          return;
        }
      } catch (_) {
        // sign-in failed = password is different = good
      }
    }

    const { error } = await sb.auth.updateUser({ password: newPw });

    if (error) {
      const msg = error.message || '';
      if (msg.toLowerCase().includes('same') || msg.toLowerCase().includes('different')) {
        alertBox.textContent = 'Your new password cannot be the same as your current password. Please choose a different one.';
      } else {
        alertBox.textContent = msg || 'Failed to reset password. Please try again.';
      }
      alertBox.className = 'alert show';
      subBtn.classList.remove('loading');
      subBtn.disabled = false;
      return;
    }

    show('successView');
  } catch (err) {
    alertBox.textContent = err.message || 'Something went wrong. Please request a new reset link.';
    alertBox.className = 'alert show';
    subBtn.classList.remove('loading');
    subBtn.disabled = false;
  }
});
</script>
</body>
</html>
